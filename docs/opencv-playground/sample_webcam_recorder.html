<html>
  <head>
    <style>
      html,
      body {
        margin: 0;
        width: 100%;
        height: 100%;
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
    </style>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.9.5/dist/ffmpeg.min.js"></script>
  </head>
  <body>
    <h3>Record video from webcam -> video using MediaRecorder</h3>
    <div>
      <video
        id="webcam"
        width="320px"
        height="180px"
        muted
        loop
        playsinline
      ></video>
      <video id="output-video" width="320px" height="180px" controls></video>
    </div>
    <button id="record" disabled>Start Recording</button>
    <input id="uploader" type="file" accept="video/*;capture=camera" capture />
    <a id="downloadLink">download</a>
    <p id="message"></p>
    <pre id="info"></pre>
    <script>
      videoUpload();
      const codec = printCheckSupport();
      const webcam = document.getElementById("webcam");
      const recordBtn = document.getElementById("record");
      let extFile = codec.includes("webm") ? "webm" : "mp4";
      const startRecording = () => {
        const rec = new MediaRecorder(webcam.srcObject, {
          mimeType: codec,
          videoBitsPerSecond: 800000,
        });
        let chunks = [];

        recordBtn.textContent = "Stop Recording";
        recordBtn.onclick = () => {
          rec.stop();
          recordBtn.textContent = "Start Recording";
          recordBtn.onclick = startRecording;
        };

        rec.ondataavailable = (e) => chunks.push(e.data);
        rec.onstop = async () => {
          console.log("aaaaa", { chunks, codec });
          var blob = new Blob(chunks, { type: codec });
          window.tmp = { chunks, codec };

          // ffmpeg convert to webm
          if (extFile === "webm") {
            const mp4ArrayBuffer = await convertWebmToMp4(
              await blob.arrayBuffer()
            );
            blob = new Blob([mp4ArrayBuffer], { type: "video/mp4" });
            extFile = "mp4";
          }

          const url = URL.createObjectURL(blob);
          show(url);
          chunks = [];
        };
        rec.start();
      };

      (async () => {
        webcam.srcObject = await navigator.mediaDevices.getUserMedia({
          video: true,
          // audio: true,
        });
        await webcam.play();
        recordBtn.disabled = false;
        recordBtn.onclick = startRecording;
      })();

      function show(url) {
        const video = document.getElementById("output-video");
        video.src = url;

        const link = document.getElementById("downloadLink");
        link.href = url;
        link.download = `test.${extFile}`;
      }

      async function convertWebmToMp4(arrayBuffer) {
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });

        const message = document.getElementById("message");
        message.innerHTML = "Loading ffmpeg-core.js";
        await ffmpeg.load();
        message.innerHTML = "Start transcoding";

        console.log("aaa", arrayBuffer);

        const name = "record.webm";
        ffmpeg.FS("writeFile", name, await fetchFile(arrayBuffer));
        await ffmpeg.run("-i", name, "-c", "copy", "output.mp4");
        message.innerHTML = "Complete transcoding";
        const data = ffmpeg.FS("readFile", "output.mp4");
        return data.buffer;
      }

      function printCheckSupport(params) {
        const info = document.getElementById("info");
        if (!window.MediaRecorder) return;
        if (!MediaRecorder.isTypeSupported) return;
        var types = [
          "video/mp4",
          "video/webm",
          "video/webm\;codecs=h264",
          "video/webm\;codecs=vp9",
          "video/webm\;codecs=vp8",
          "video/webm\;codecs=daala",
          "audio/webm\;codecs=opus",
          "video/avi",
          "video/mpeg",
        ];

        let selectedMime = undefined;

        for (var i in types) {
          const isSupport = MediaRecorder.isTypeSupported(types[i]);
          const c =
            "Is " + types[i] + " supported? " + (isSupport ? "Yes!" : "No :(");
          console.log(c);
          info.append(`${c}\n`);

          if (isSupport && !selectedMime) selectedMime = types[i];
        }
        info.append(`\nWill record with mimeType: ${selectedMime}\n`);
        return selectedMime;
      }

      function videoUpload() {
        const uploader = document.getElementById("uploader");
        uploader.onchange = (ev) => {
          var reader = new FileReader();
          reader.readAsDataURL(ev.target.files[0]);
          reader.onloadend = async (e) => {
            const blob = await fetch(reader.result).then((res) => res.blob());
            const url = URL.createObjectURL(blob);
            show(url);
          };
        };
      }
    </script>
  </body>
</html>
